{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .hidden { display: none; }

        /* Sidebar collapse animation */
        #sidebar {
            transition: width 0.3s ease;
            min-height: 100vh;
        }

        #sidebar.collapsed {
            width: 70px;
        }

        #sidebar.collapsed .menu-text,
        #sidebar.collapsed .submenu {
            display: none;
        }

        #sidebar.collapsed .menu-icon {
            margin: 0 auto;
        }

        /* Tooltip styles */
        .tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 13px;
            padding: 5px 10px;
            border-radius: 6px;
            white-space: nowrap;
            margin-left: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        #sidebar.collapsed .group:hover .tooltip {
            opacity: 1;
        }

        /* Smooth fade for dropdown */
        #filterDropdown {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- Header -->
    <header class="flex items-center justify-between bg-white shadow p-4 sticky top-0 z-40">
        <div class="flex items-center space-x-4">
            <button onclick="collapseSidebar()" class="text-2xl text-gray-600 hover:text-black">‚ò∞</button>
            <a href="{% url 'dashboard' %}">
                <img src="{% static 'images/logo.png' %}" alt="Logo" class="w-[180px] ml-[-8px]" />
            </a>
        </div>
        <div class="flex items-center gap-3 text-sm">
            <span class="text-gray-700 font-medium hidden sm:block">Welcome, {{ request.user.username }}</span>
            <a href="{% url 'profile' %}" class="text-blue-600 hover:underline">Profile</a>
            <a href="{% url 'logout' %}" class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">Logout</a>
        </div>
    </header>

    <div class="flex flex-col md:flex-row">

        <!-- Sidebar -->
        <aside id="sidebar" class="bg-white border-r border-gray-200 p-4 w-[250px] md:fixed md:h-screen md:top-[100px] z-30">
            <h2 class="text-xl font-bold mb-4 text-gray-800 menu-text">Main Menu</h2>

            {% if request.user.is_superuser %}
            <div class="mb-4 relative group">
                <button onclick="toggleMenu('adminMenu')" class="w-full flex items-center gap-3 py-2 px-3 bg-gray-100 hover:bg-gray-200 rounded font-bold">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    <span class="menu-text">Admin</span>
                    <div class="tooltip">Admin</div>
                </button>
                <div id="adminMenu" class="ml-6 mt-2 hidden submenu">
                    <a href="{% url 'user_list' %}" class="block py-1 text-gray-700 hover:text-blue-600">üë§ Users</a>
                </div>
            </div>
            {% endif %}

            <div class="mb-4 relative group">
                <button onclick="toggleMenu('salesMenu')" class="w-full flex items-center gap-3 py-2 px-3 bg-blue-100 hover:bg-blue-200 rounded font-bold">
                    <span class="menu-icon">üíº</span>
                    <span class="menu-text">Sales</span>
                    <div class="tooltip">Sales</div>
                </button>
                <div id="salesMenu" class="ml-6 mt-2 hidden submenu">
                    {% if perms.crm.view_client %}
                    <a href="/client/" class="block py-1 text-blue-700 hover:underline font-semibold">üßæ Client</a>
                    {% endif %}
                    {% if perms.crm.view_lead %}
                    <a href="/lead/" class="block py-1 text-blue-700 hover:underline font-semibold">üìã Lead</a>
                    {% endif %}
                    {% if perms.crm.view_estimation %}
                    <a href="/estimation/" class="block py-1 text-blue-700 hover:underline font-semibold">üìê Estimation</a>
                    {% endif %}
                    {% if perms.crm.view_invoice %}
                    <a href="/invoices/" class="block py-1 text-blue-700 hover:underline font-semibold">üßæ Invoice</a>
                    {% endif %}
                    {% if perms.crm.view_report %}
                    <a href="{% url 'report_list' %}" class="block py-1 text-blue-700 hover:underline font-semibold">üìä Reports</a>
                    {% endif %}
                </div>
            </div>

            {% if request.user.is_superuser %}
            <div class="mb-4 relative group">
                <button onclick="toggleMenu('purchaseMenu')" class="w-full flex items-center gap-3 py-2 px-3 bg-green-100 hover:bg-green-200 rounded font-bold">
                    <span class="menu-icon">üõí</span>
                    <span class="menu-text">Purchase</span>
                    <div class="tooltip">Purchase</div>
                </button>
                <div id="purchaseMenu" class="ml-6 mt-2 hidden submenu">
                    <a href="{% url 'vendor' %}" class="block py-1 text-green-700 hover:underline font-semibold">Vendor</a>
                    <a href="#" class="block py-1 text-green-700 hover:underline font-semibold">PO</a>
                    <a href="#" class="block py-1 text-green-700 hover:underline font-semibold">Bill</a>
                </div>
            </div>
            {% endif %}
        </aside>

        <!-- Main Content -->
        <main class="flex-1 md:ml-[250px] p-6 bg-gray-50">
            <div class="flex flex-col lg:flex-row justify-between items-center mb-6 gap-4">
                <div class="bg-gradient-to-r from-blue-100 via-purple-100 to-pink-100 p-6 rounded-2xl shadow-md text-center w-full lg:max-w-3xl">
                    <h2 class="text-2xl font-extrabold text-gray-800">Welcome, {{ request.user.username }}</h2>
                    <p id="motivation" class="text-gray-600 mt-2"></p>
                </div>
                <div class="relative">
                    <button id="filterToggle" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded-lg shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L15 13.414V19a1 1 0 01-.553.894l-4 2A1 1 0 019 21v-7.586L3.293 6.707A1 1 0 013 6V4z" />
                        </svg>
                        Filter
                    </button>
                    <div id="filterDropdown" class="absolute right-0 mt-2 w-64 bg-white border border-gray-200 rounded-xl shadow-lg z-50 hidden">
                        <h3 class="text-lg font-bold mb-2 px-4 pt-3">Filter</h3>
                        <form method="get" class="px-4 pb-3">
                            {% for label, value in filter_options %}
                            <label class="block mt-1">
                                <input type="radio" name="date_filter" value="{{ value }}"
                                       {% if selected_filter == value %}checked{% endif %}> {{ label }}
                            </label>
                            {% endfor %}
                            <button type="submit" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded">Apply</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded shadow text-center"><h2 class="text-lg font-semibold">Leads</h2><p class="text-2xl text-blue-600">{{ total_leads }}</p></div>
                <div class="bg-white p-4 rounded shadow text-center"><h2 class="text-lg font-semibold">Quotations</h2><p class="text-2xl text-yellow-600">{{ total_quotations }}</p></div>
                <div class="bg-white p-4 rounded shadow text-center"><h2 class="text-lg font-semibold">Invoices</h2><p class="text-2xl text-green-600">{{ total_invoices }}</p></div>
                <div class="bg-white p-4 rounded shadow text-center"><h2 class="text-lg font-semibold">Lead ‚Üí Invoice %</h2><p class="text-2xl text-purple-600">{{ conversion_rate }}%</p></div>
            </div>

            <!-- Invoice Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-blue-100 text-blue-900 rounded-xl shadow px-6 py-4 text-center">
                    <h3 class="text-md font-semibold">Total Invoiced</h3>
                    <p class="text-xl font-bold">‚Çπ {{ total_invoiced|floatformat:2 }}</p>
                </div>
                <div class="bg-green-100 text-green-900 rounded-xl shadow px-6 py-4 text-center">
                    <h3 class="text-md font-semibold">Paid</h3>
                    <p class="text-xl font-bold">‚Çπ {{ paid|floatformat:2 }}</p>
                </div>
                <div class="bg-red-100 text-red-900 rounded-xl shadow px-6 py-4 text-center">
                    <h3 class="text-md font-semibold">Balance Due</h3>
                    <p class="text-xl font-bold">‚Çπ {{ balance_due|floatformat:2 }}</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
                <div class="bg-white p-4 rounded-2xl shadow flex flex-col items-center min-h-[350px]">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Quotation Status</h3>
                    <canvas id="quotationStatusChart" class="w-full max-w-[300px]"></canvas>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow flex flex-col min-h-[350px]">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Lead Source</h3>
                    <canvas id="sourceChart"></canvas>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow flex flex-col min-h-[350px]">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Top 4 Clients</h3>
                    <canvas id="assigneeChart"></canvas>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow flex flex-col items-center min-h-[350px]">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Quotation & Invoice Status</h3>
                    <canvas id="statusChart" class="w-full max-w-[300px]"></canvas>
                </div>
            </div>

            <!-- Footer -->
            <footer class="bg-white text-right text-gray-600 p-4 shadow mt-6 rounded-lg">
                Designed & Developed By <span class="font-semibold">Nagaraj Nada</span>
            </footer>
        </main>
    </div>

    <!-- JS -->
    <script>
        // Sidebar Collapse
        function collapseSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        // Menu Toggle
        function toggleMenu(id) {
            document.getElementById(id).classList.toggle('hidden');
        }

        // Filter Dropdown
        document.addEventListener("DOMContentLoaded", function () {
            const toggleBtn = document.getElementById("filterToggle");
            const dropdown = document.getElementById("filterDropdown");

            toggleBtn.addEventListener("click", function (event) {
                event.stopPropagation();
                dropdown.classList.toggle("hidden");
            });
            document.addEventListener("click", function (event) {
                if (!dropdown.contains(event.target) && !toggleBtn.contains(event.target)) {
                    dropdown.classList.add("hidden");
                }
            });

            // Random motivational message
            const messages = [
                "Believe you can and you're halfway there!",
                "Stay focused, stay humble, stay strong!",
                "Small steps every day lead to big success!",
                "Your hard work will pay off ‚Äî keep going!",
                "Dream big, work hard, make it happen!"
            ];
            document.getElementById("motivation").textContent =
                messages[Math.floor(Math.random() * messages.length)];
        });
    </script>

    <!-- Charts -->
    <script>
        new Chart(document.getElementById('statusChart'), {
            type: 'doughnut',
            data: {
                labels: [{% for q in quotation_status %}"{{ q.status }}",{% endfor %}{% for i in invoice_status %}"{{ i.status }}",{% endfor %}],
                datasets: [{
                    data: [{% for q in quotation_status %}{{ q.count }},{% endfor %}{% for i in invoice_status %}{{ i.count }},{% endfor %}],
                    backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#F44336', '#9C27B0']
                }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });

        new Chart(document.getElementById('sourceChart'), {
            type: 'bar',
            data: { labels: ['Call', 'Email', 'Portal', 'Social'], datasets: [{ data: [24, 10, 6, 1], backgroundColor: '#F59E0B' }] },
            options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
        });

        new Chart(document.getElementById('assigneeChart'), {
            type: 'bar',
            data: { labels: ['William', 'Sarah', 'Peter', 'Jason'], datasets: [{ data: [5, 16, 2, 3], backgroundColor: '#EC4899' }] },
            options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }
        });

        new Chart(document.getElementById('quotationStatusChart'), {
            type: 'doughnut',
            data: { labels: ['Pending', 'Approved', 'Rejected'], datasets: [{ data: [12, 8, 3], backgroundColor: ['#3B82F6', '#10B981', '#EF4444'] }] },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
    </script>
</body>
</html>
