{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
.invoice-table {
    border-collapse: collapse;
    table-layout: fixed; /* 🔥 KEY for alignment */
}

.invoice-table th,
.invoice-table td {
    border: 1px solid #d1d5db;
    padding: 6px 8px;
    vertical-align: middle;
    text-align: center;
    white-space: nowrap;
}

.invoice-table th {
    background: #f3f4f6;
    font-weight: 600;
}

/* Description column */
.invoice-table td:nth-child(2) {
    text-align: left;
    white-space: normal;
}

/* Inputs */
.invoice-table input,
.invoice-table select,
.invoice-table textarea {
    width: 100%;
    height: 34px;           /* 🔥 SAME HEIGHT */
    padding: 4px 6px;
    font-size: 13px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    box-sizing: border-box;
}

/* Textarea fix */
.invoice-table textarea {
    resize: none;
    height: 34px;           /* 🔥 PREVENT ROW STRETCH */
    line-height: 1.3;
}

/* Numbers alignment */
.invoice-table td:nth-child(4),
.invoice-table td:nth-child(6),
.invoice-table td:nth-child(7),
.invoice-table td:nth-child(8) {
    text-align: right;
}
</style>

<div class="max-w-7xl mx-auto p-8 bg-gray-50 rounded-xl shadow mt-6">

<h2 class="text-3xl font-bold text-center mb-8">Edit Invoice</h2>

<form method="POST">
{% csrf_token %}

<!-- ================= HEADER ================= -->
<div class="bg-white rounded-xl shadow p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-700 mb-4">Invoice Details</h3>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">

        <!-- Invoice No -->
        <div class="flex flex-col">
            <label class="text-sm font-medium text-gray-600 mb-1">Invoice No</label>
            <input type="text" value="{{ invoice.invoice_no }}" readonly
                   class="bg-gray-100 px-3 py-2 rounded-lg border">
        </div>

        <!-- Invoice Date -->
        <div class="flex flex-col">
            <label class="text-sm font-medium text-gray-600 mb-1">Invoice Date</label>
            <input type="date" name="invoice_date"
                   value="{{ invoice.invoice_date|date:'Y-m-d' }}"
                   class="px-3 py-2 rounded-lg border">
        </div>

        <!-- Credit Days -->
        <div class="flex flex-col">
            <label class="text-sm font-medium text-gray-600 mb-1">Credit Days</label>
            <input type="number" name="credit_days"
                   value="{{ invoice.credit_days }}"
                   class="px-3 py-2 rounded-lg border">
        </div>

        <!-- Company -->
        <div class="flex flex-col">
            <label class="text-sm font-medium text-gray-600 mb-1">Company</label>
            <input type="text" value="{{ estimation.company_name }}" readonly
                   class="bg-gray-100 px-3 py-2 rounded-lg border">
        </div>

        <!-- PO Number -->
        <div class="flex flex-col">
            <label class="text-sm font-medium text-gray-600 mb-1">PO Number</label>
            <input type="text" name="po_number"
                   value="{{ estimation.po_number }}"
                   class="px-3 py-2 rounded-lg border">
        </div>

        <!-- GSTIN -->
        <div class="flex flex-col">
            <label class="text-sm font-medium text-gray-600 mb-1">GSTIN</label>
            <input type="text" name="gst_no"
                   value="{{ estimation.gst_no|default:'URP' }}"
                   class="px-3 py-2 rounded-lg border bg-gray-50">
        </div>

    </div>
</div>


<!-- ================= ADDRESS ================= -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label class="font-semibold">Billing Address</label>
            <textarea name="billing_address" rows="3" class="w-full border px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-500">{{ estimation.billing_address }}</textarea>
        </div>

        <div>
            <label class="font-semibold">Shipping Address</label>
            <textarea name="shipping_address" rows="3" class="w-full border px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-500">{{ estimation.shipping_address }}</textarea>
        </div>
    </div>
<!-- ================= ITEMS ================= -->
<!-- ================= ITEMS ================= -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex justify-between mb-4">
        <h3 class="text-lg font-semibold">Invoice Items</h3>
        <button type="button" onclick="addRow()" class="text-blue-600 font-semibold">
            ➕ Add Item
        </button>
    </div>

    <div class="overflow-x-auto">
        <table class="invoice-table w-full text-sm border border-gray-300">
            <thead>
                <tr>
                    <th>#</th>
                    <th class="text-left">Description</th>
                    <th>HSN / SAC</th>
                    <th>Qty</th>
                    <th>UOM</th>
                    <th>Rate</th>
                    <th>Tax %</th>
                    <th>Amount</th>
                    <th>Del</th>
                </tr>
            </thead>

            <tbody id="itemsTableBody">
                {{ formset.management_form }}

                {% for form in formset %}
                <tr>
                    {{ form.id }}
                    <td>{{ forloop.counter }}</td>
                    <td class="text-left">{{ form.item_details }}</td>
                    <td>{{ form.hsn_sac }}</td>
                    <td>{{ form.quantity }}</td>
                    <td>{{ form.uom }}</td>
                    <td>{{ form.rate }}</td>
                    <td>{{ form.tax }}</td>
                    <td class="amount text-right">0.00</td>
                    <td class="text-center">{{ form.DELETE }}</td>
                </tr>
                {% endfor %}

                <!-- EMPTY FORM -->
                <tr id="empty-form" class="hidden">
                    <td>__prefix__</td>
                    <td class="text-left">{{ formset.empty_form.item_details }}</td>
                    <td>{{ formset.empty_form.hsn_sac }}</td>
                    <td>{{ formset.empty_form.quantity }}</td>
                    <td>{{ formset.empty_form.uom }}</td>
                    <td>{{ formset.empty_form.rate }}</td>
                    <td>{{ formset.empty_form.tax }}</td>
                    <td class="amount text-right">0.00</td>
                    <td>—</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- ================= TOTALS ================= -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
        <div>
            <label class="font-semibold">Sub Total</label>
            <input type="text" id="subTotal" readonly
                   class="w-full border px-3 py-2 rounded bg-gray-100">
        </div>

        <div>
            <label class="font-semibold">GST</label>
            <input type="text" id="gstTotal" readonly
                   class="w-full border px-3 py-2 rounded bg-gray-100">
        </div>

        <div>
            <label class="font-semibold">Grand Total</label>
            <input type="text" id="grandTotal" readonly
                   class="w-full border px-3 py-2 rounded bg-green-100 font-bold">
        </div>
    </div>
</div>



<!-- ================= TERMS ================= -->
<div class="mt-6">
    <label class="block font-semibold mb-2 text-gray-700">
        Terms & Conditions
    </label>

    <textarea name="terms_conditions"
              rows="6"
              class="w-full border px-3 py-2 rounded-lg
                     focus:ring-2 focus:ring-blue-500
                     text-sm leading-relaxed whitespace-pre-line">
{{ estimation.terms_conditions }}
    </textarea>
</div>

<!-- ================= ACTIONS ================= -->
<div class="flex justify-end gap-4">
    <a href="{% url 'invoice_list' %}"
       class="px-6 py-2 bg-gray-500 text-white rounded">
        Cancel
    </a>

    <button type="submit"
            class="px-6 py-2 bg-green-600 text-white rounded font-semibold">
        💾 Save Invoice
    </button>
</div>

</form>
</div>

<script>
function addRow() {
    const tbody = document.getElementById("itemsTableBody");
    const totalForms = document.querySelector('input[name="form-TOTAL_FORMS"]');
    const index = parseInt(totalForms.value);

    const template = document.getElementById("empty-form").cloneNode(true);
    template.classList.remove("hidden");
    template.removeAttribute("id");

    template.innerHTML = template.innerHTML.replace(/__prefix__/g, index);
    tbody.appendChild(template);

    totalForms.value = index + 1;
    recalc();
}

function recalc() {
    let subTotal = 0;
    let gstTotal = 0;

    document.querySelectorAll("#itemsTableBody tr").forEach(row => {

        const qtyInput = row.querySelector('input[name$="-quantity"]');
        const rateInput = row.querySelector('input[name$="-rate"]');
        const taxInput = row.querySelector('select[name$="-tax"]');
        const amountCell = row.querySelector(".amount");

        if (!qtyInput || !rateInput || !amountCell) return;

        const qty = parseFloat(qtyInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        const tax = parseFloat(taxInput?.value || 0);

        const base = qty * rate;
        const taxAmount = (base * tax) / 100;
        const total = base + taxAmount;

        subTotal += base;
        gstTotal += taxAmount;

        amountCell.innerText = total.toFixed(2);
    });

    document.getElementById("subTotal").value = subTotal.toFixed(2);
    document.getElementById("gstTotal").value = gstTotal.toFixed(2);
    document.getElementById("grandTotal").value = (subTotal + gstTotal).toFixed(2);
}

document.addEventListener("input", recalc);
document.addEventListener("DOMContentLoaded", recalc);
</script>

{% endblock %}
